<template>
  <div class="container mx-auto py-8">
    <h1 class="text-3xl font-bold mb-6">üìä Exportador de Dados</h1>
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      
      <!-- Exportar Clientes -->
      <Card>
        <CardHeader>
          <CardTitle class="flex items-center gap-2">
            <Users class="h-5 w-5" />
            Clientes
          </CardTitle>
          <CardDescription>
            Exporte todos os seus clientes cadastrados
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div class="space-y-2 text-sm text-muted-foreground">
            <p>‚Ä¢ Nome completo</p>
            <p>‚Ä¢ Email</p>
            <p>‚Ä¢ Telefone</p>
          </div>
        </CardContent>
        <CardFooter class="flex flex-col gap-2">
          <Button @click="exportarClientes('xlsx')" :disabled="isExporting" class="w-full">
            <FileSpreadsheet class="mr-2 h-4 w-4" />
            Exportar Excel (.xlsx)
          </Button>
          <Button @click="exportarClientes('csv')" :disabled="isExporting" variant="outline" class="w-full">
            <FileText class="mr-2 h-4 w-4" />
            Exportar CSV
          </Button>
          <Button @click="exportarClientes('json')" :disabled="isExporting" variant="outline" class="w-full">
            <FileJson class="mr-2 h-4 w-4" />
            Exportar JSON
          </Button>
        </CardFooter>
      </Card>

      <!-- Exportar Ordens de Servi√ßo -->
      <Card>
        <CardHeader>
          <CardTitle class="flex items-center gap-2">
            <ClipboardList class="h-5 w-5" />
            Ordens de Servi√ßo
          </CardTitle>
          <CardDescription>
            Exporte todas as ordens de servi√ßo
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div class="space-y-2 text-sm text-muted-foreground">
            <p>‚Ä¢ Cliente</p>
            <p>‚Ä¢ Data</p>
            <p>‚Ä¢ Valor total</p>
            <p>‚Ä¢ Servi√ßos realizados</p>
          </div>
        </CardContent>
        <CardFooter class="flex flex-col gap-2">
          <Button @click="exportarOrdensServico('xlsx')" :disabled="isExporting" class="w-full">
            <FileSpreadsheet class="mr-2 h-4 w-4" />
            Exportar Excel (.xlsx)
          </Button>
          <Button @click="exportarOrdensServico('csv')" :disabled="isExporting" variant="outline" class="w-full">
            <FileText class="mr-2 h-4 w-4" />
            Exportar CSV
          </Button>
          <Button @click="exportarOrdensServico('json')" :disabled="isExporting" variant="outline" class="w-full">
            <FileJson class="mr-2 h-4 w-4" />
            Exportar JSON
          </Button>
        </CardFooter>
      </Card>

      <!-- Exportar Invent√°rio -->
      <Card>
        <CardHeader>
          <CardTitle class="flex items-center gap-2">
            <Package class="h-5 w-5" />
            Invent√°rio
          </CardTitle>
          <CardDescription>
            Exporte todo o invent√°rio de produtos
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div class="space-y-2 text-sm text-muted-foreground">
            <p>‚Ä¢ Nome do item</p>
            <p>‚Ä¢ Tipo</p>
            <p>‚Ä¢ Pre√ßo de custo</p>
            <p>‚Ä¢ Pre√ßo de venda</p>
            <p>‚Ä¢ Quantidade em estoque</p>
          </div>
        </CardContent>
        <CardFooter class="flex flex-col gap-2">
          <Button @click="exportarInventario('xlsx')" :disabled="isExporting" class="w-full">
            <FileSpreadsheet class="mr-2 h-4 w-4" />
            Exportar Excel (.xlsx)
          </Button>
          <Button @click="exportarInventario('csv')" :disabled="isExporting" variant="outline" class="w-full">
            <FileText class="mr-2 h-4 w-4" />
            Exportar CSV
          </Button>
          <Button @click="exportarInventario('json')" :disabled="isExporting" variant="outline" class="w-full">
            <FileJson class="mr-2 h-4 w-4" />
            Exportar JSON
          </Button>
        </CardFooter>
      </Card>

      <!-- Exportar Cat√°logo de Servi√ßos -->
      <Card>
        <CardHeader>
          <CardTitle class="flex items-center gap-2">
            <BookOpen class="h-5 w-5" />
            Cat√°logo de Servi√ßos
          </CardTitle>
          <CardDescription>
            Exporte o cat√°logo de servi√ßos predefinidos
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div class="space-y-2 text-sm text-muted-foreground">
            <p>‚Ä¢ Nome do servi√ßo</p>
            <p>‚Ä¢ Descri√ß√£o</p>
            <p>‚Ä¢ Pre√ßo</p>
          </div>
        </CardContent>
        <CardFooter class="flex flex-col gap-2">
          <Button @click="exportarCatalogo('xlsx')" :disabled="isExporting" class="w-full">
            <FileSpreadsheet class="mr-2 h-4 w-4" />
            Exportar Excel (.xlsx)
          </Button>
          <Button @click="exportarCatalogo('csv')" :disabled="isExporting" variant="outline" class="w-full">
            <FileText class="mr-2 h-4 w-4" />
            Exportar CSV
          </Button>
          <Button @click="exportarCatalogo('json')" :disabled="isExporting" variant="outline" class="w-full">
            <FileJson class="mr-2 h-4 w-4" />
            Exportar JSON
          </Button>
        </CardFooter>
      </Card>

      <!-- Exporta√ß√£o Completa -->
      <Card class="md:col-span-2 lg:col-span-1">
        <CardHeader>
          <CardTitle class="flex items-center gap-2">
            <Database class="h-5 w-5" />
            Backup Completo
          </CardTitle>
          <CardDescription>
            Exporte todos os dados de uma vez
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div class="space-y-2 text-sm text-muted-foreground">
            <p>‚Ä¢ Todos os clientes</p>
            <p>‚Ä¢ Todas as ordens</p>
            <p>‚Ä¢ Todo o invent√°rio</p>
            <p>‚Ä¢ Cat√°logo completo</p>
          </div>
        </CardContent>
        <CardFooter class="flex flex-col gap-2">
          <Button @click="exportarTudo('xlsx')" :disabled="isExporting" class="w-full" variant="default">
            <Download class="mr-2 h-4 w-4" />
            Backup Completo (Excel)
          </Button>
          <Button @click="exportarTudo('json')" :disabled="isExporting" variant="outline" class="w-full">
            <Download class="mr-2 h-4 w-4" />
            Backup Completo (JSON)
          </Button>
        </CardFooter>
      </Card>

    </div>

    <!-- Status de Exporta√ß√£o -->
    <div v-if="isExporting" class="mt-8 p-4 bg-muted rounded-lg text-center">
      <Loader2 class="h-6 w-6 animate-spin mx-auto mb-2" />
      <p class="text-sm text-muted-foreground">Preparando exporta√ß√£o...</p>
    </div>
  </div>
</template>

<script setup>
import { ref } from 'vue';
import { db } from '@/firebase/config.js';
import { collection, getDocs } from 'firebase/firestore';
import { useCurrentStore } from '@/composables/useCurrentStore';
import * as XLSX from 'xlsx';

import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';
import { 
  Users, 
  ClipboardList, 
  Package, 
  BookOpen, 
  Database,
  FileSpreadsheet, 
  FileText, 
  FileJson,
  Download,
  Loader2
} from 'lucide-vue-next';

const { storeId } = useCurrentStore();
const isExporting = ref(false);

// ============================================================================
// FUN√á√ïES DE EXPORTA√á√ÉO POR TIPO
// ============================================================================

async function exportarClientes(formato) {
  if (!storeId.value) {
    alert('Erro: Usu√°rio n√£o autenticado');
    return;
  }

  isExporting.value = true;

  try {
    const col = collection(db, 'stores', storeId.value, 'clientes');
    const snapshot = await getDocs(col);
    
    const dados = snapshot.docs.map(doc => ({
      ID: doc.id,
      Nome: doc.data().nome || '',
      Email: doc.data().email || '',
      Telefone: doc.data().telefone || '',
    }));

    if (dados.length === 0) {
      alert('Nenhum cliente encontrado para exportar.');
      return;
    }

    exportar(dados, 'Clientes', formato);
  } catch (error) {
    console.error('Erro ao exportar clientes:', error);
    alert('Erro ao exportar clientes: ' + error.message);
  } finally {
    isExporting.value = false;
  }
}

async function exportarOrdensServico(formato) {
  if (!storeId.value) {
    alert('Erro: Usu√°rio n√£o autenticado');
    return;
  }

  isExporting.value = true;

  try {
    const col = collection(db, 'stores', storeId.value, 'ordens_servico');
    const snapshot = await getDocs(col);
    
    const dados = snapshot.docs.map(doc => {
      const data = doc.data();
      return {
        ID: doc.id,
        Cliente: data.customerName || '',
        Data: data.date?.toDate ? data.date.toDate().toLocaleDateString('pt-BR') : '',
        'Valor do Servi√ßo': data.price || 0,
        'Valor Total': data.totalAmount || 0,
        'Observa√ß√µes': Array.isArray(data.observations) ? data.observations.join('; ') : data.observations || '',
        'Configura√ß√£o do Equipamento': data.computerConfiguration || '',
      };
    });

    if (dados.length === 0) {
      alert('Nenhuma ordem de servi√ßo encontrada para exportar.');
      return;
    }

    exportar(dados, 'Ordens_Servico', formato);
  } catch (error) {
    console.error('Erro ao exportar ordens:', error);
    alert('Erro ao exportar ordens de servi√ßo: ' + error.message);
  } finally {
    isExporting.value = false;
  }
}

async function exportarInventario(formato) {
  if (!storeId.value) {
    alert('Erro: Usu√°rio n√£o autenticado');
    return;
  }

  isExporting.value = true;

  try {
    const col = collection(db, 'stores', storeId.value, 'items');
    const snapshot = await getDocs(col);
    
    const dados = snapshot.docs.map(doc => {
      const data = doc.data();
      return {
        ID: doc.id,
        Nome: data.nome || '',
        Tipo: data.tipo || '',
        'Pre√ßo de Custo': data.precoCusto || 0,
        'Pre√ßo de Venda': data.precoVenda || 0,
        Quantidade: data.quantidade || 0,
        Descri√ß√£o: data.descricao || '',
      };
    });

    if (dados.length === 0) {
      alert('Nenhum item encontrado para exportar.');
      return;
    }

    exportar(dados, 'Inventario', formato);
  } catch (error) {
    console.error('Erro ao exportar invent√°rio:', error);
    alert('Erro ao exportar invent√°rio: ' + error.message);
  } finally {
    isExporting.value = false;
  }
}

async function exportarCatalogo(formato) {
  if (!storeId.value) {
    alert('Erro: Usu√°rio n√£o autenticado');
    return;
  }

  isExporting.value = true;

  try {
    const col = collection(db, 'stores', storeId.value, 'catalogo_servicos');
    const snapshot = await getDocs(col);
    
    const dados = snapshot.docs.map(doc => ({
      ID: doc.id,
      Nome: doc.data().nome || '',
      Descri√ß√£o: doc.data().descricao || '',
      Pre√ßo: doc.data().preco || 0,
    }));

    if (dados.length === 0) {
      alert('Nenhum servi√ßo encontrado para exportar.');
      return;
    }

    exportar(dados, 'Catalogo_Servicos', formato);
  } catch (error) {
    console.error('Erro ao exportar cat√°logo:', error);
    alert('Erro ao exportar cat√°logo: ' + error.message);
  } finally {
    isExporting.value = false;
  }
}

async function exportarTudo(formato) {
  if (!storeId.value) {
    alert('Erro: Usu√°rio n√£o autenticado');
    return;
  }

  isExporting.value = true;

  try {
    // Buscar todos os dados
    const [clientesSnap, ordensSnap, itemsSnap, catalogoSnap] = await Promise.all([
      getDocs(collection(db, 'stores', storeId.value, 'clientes')),
      getDocs(collection(db, 'stores', storeId.value, 'ordens_servico')),
      getDocs(collection(db, 'stores', storeId.value, 'items')),
      getDocs(collection(db, 'stores', storeId.value, 'catalogo_servicos')),
    ]);

    if (formato === 'json') {
      // Exportar como JSON completo
      const backup = {
        dataExportacao: new Date().toISOString(),
        storeId: storeId.value,
        clientes: clientesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })),
        ordensServico: ordensSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })),
        inventario: itemsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })),
        catalogoServicos: catalogoSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })),
      };

      const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
      baixarArquivo(blob, `Backup_Completo_${getDataHora()}.json`);
    } else {
      // Exportar como Excel com m√∫ltiplas abas
      const wb = XLSX.utils.book_new();

      // Aba Clientes
      const clientesDados = clientesSnap.docs.map(doc => ({
        ID: doc.id,
        Nome: doc.data().nome || '',
        Email: doc.data().email || '',
        Telefone: doc.data().telefone || '',
      }));
      const wsClientes = XLSX.utils.json_to_sheet(clientesDados);
      XLSX.utils.book_append_sheet(wb, wsClientes, 'Clientes');

      // Aba Ordens de Servi√ßo
      const ordensDados = ordensSnap.docs.map(doc => {
        const data = doc.data();
        return {
          ID: doc.id,
          Cliente: data.customerName || '',
          Data: data.date?.toDate ? data.date.toDate().toLocaleDateString('pt-BR') : '',
          'Valor Total': data.totalAmount || 0,
        };
      });
      const wsOrdens = XLSX.utils.json_to_sheet(ordensDados);
      XLSX.utils.book_append_sheet(wb, wsOrdens, 'Ordens de Servi√ßo');

      // Aba Invent√°rio
      const inventarioDados = itemsSnap.docs.map(doc => {
        const data = doc.data();
        return {
          ID: doc.id,
          Nome: data.nome || '',
          Tipo: data.tipo || '',
          'Pre√ßo Custo': data.precoCusto || 0,
          'Pre√ßo Venda': data.precoVenda || 0,
          Quantidade: data.quantidade || 0,
        };
      });
      const wsInventario = XLSX.utils.json_to_sheet(inventarioDados);
      XLSX.utils.book_append_sheet(wb, wsInventario, 'Invent√°rio');

      // Aba Cat√°logo
      const catalogoDados = catalogoSnap.docs.map(doc => ({
        ID: doc.id,
        Nome: doc.data().nome || '',
        Descri√ß√£o: doc.data().descricao || '',
        Pre√ßo: doc.data().preco || 0,
      }));
      const wsCatalogo = XLSX.utils.json_to_sheet(catalogoDados);
      XLSX.utils.book_append_sheet(wb, wsCatalogo, 'Cat√°logo Servi√ßos');

      XLSX.writeFile(wb, `Backup_Completo_${getDataHora()}.xlsx`);
    }

    alert('Backup completo exportado com sucesso!');
  } catch (error) {
    console.error('Erro ao exportar backup:', error);
    alert('Erro ao criar backup: ' + error.message);
  } finally {
    isExporting.value = false;
  }
}

// ============================================================================
// FUN√á√ïES AUXILIARES
// ============================================================================

function exportar(dados, nomeArquivo, formato) {
  const dataHora = getDataHora();

  if (formato === 'xlsx') {
    exportarExcel(dados, `${nomeArquivo}_${dataHora}.xlsx`);
  } else if (formato === 'csv') {
    exportarCSV(dados, `${nomeArquivo}_${dataHora}.csv`);
  } else if (formato === 'json') {
    exportarJSON(dados, `${nomeArquivo}_${dataHora}.json`);
  }
}

function exportarExcel(dados, nomeArquivo) {
  const ws = XLSX.utils.json_to_sheet(dados);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Dados');
  XLSX.writeFile(wb, nomeArquivo);
}

function exportarCSV(dados, nomeArquivo) {
  const ws = XLSX.utils.json_to_sheet(dados);
  const csv = XLSX.utils.sheet_to_csv(ws);
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  baixarArquivo(blob, nomeArquivo);
}

function exportarJSON(dados, nomeArquivo) {
  const json = JSON.stringify(dados, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  baixarArquivo(blob, nomeArquivo);
}

function baixarArquivo(blob, nomeArquivo) {
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = nomeArquivo;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

function getDataHora() {
  const now = new Date();
  const ano = now.getFullYear();
  const mes = String(now.getMonth() + 1).padStart(2, '0');
  const dia = String(now.getDate()).padStart(2, '0');
  const hora = String(now.getHours()).padStart(2, '0');
  const min = String(now.getMinutes()).padStart(2, '0');
  return `${ano}${mes}${dia}_${hora}${min}`;
}
</script>
